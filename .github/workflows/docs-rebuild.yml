
name: Rebuild and Commit Docs

on:
  workflow_dispatch:
  repository_dispatch:
    types: [update-docs]

jobs:
  update-docs:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Docs Repo
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Rebuild Documentation
        run: |
          REPOS=(
            "sologenic/com-be-admin-account-service"
            "sologenic/com-be-admin-asset-service"
            "sologenic/com-be-admin-certificate-service"
            "sologenic/com-be-admin-comment-service"
            "sologenic/com-be-admin-document-service"
            "sologenic/com-be-admin-feature-flag-service"
            "sologenic/com-be-admin-file-service"
            "sologenic/com-be-admin-jurisdiction-asset-mgmt-service"
            "sologenic/com-be-admin-jurisdiction-service"
            "sologenic/com-be-admin-kyc-document-service"
            "sologenic/com-be-admin-minicms-service"
            "sologenic/com-be-admin-notification-service"
            "sologenic/com-be-admin-organization-service"
            "sologenic/com-be-admin-smart-contract-management-service"
            "sologenic/com-be-admin-user-service"
            "sologenic/com-be-aed-service"
            "sologenic/com-be-alert-service"
            "sologenic/com-be-asset-service"
            "sologenic/com-be-auth-firebase-service"
            "sologenic/com-be-auth-service"
            "sologenic/com-be-comment-service"
            "sologenic/com-be-contact-list-service"
            "sologenic/com-be-document-service"
            "sologenic/com-be-email-send-service"
            "sologenic/com-be-email-template-service"
            "sologenic/com-be-feature-flag-service"
            "sologenic/com-be-file-service"
            "sologenic/com-be-holdings-service"
            "sologenic/com-be-kyc-service"
            "sologenic/com-be-minicms-service"
            "sologenic/com-be-notification-service"
            "sologenic/com-be-open-search-service"
            "sologenic/com-be-order-management-service"
            "sologenic/com-be-record-service"
            "sologenic/com-be-update-service"
            "sologenic/com-be-user-service"
            "sologenic/com-be-user-session-service"
            "sologenic/com-be-wallet-service"
            "sologenic/com-be-reference-service"
          )
          for REPO in "${REPOS[@]}"; do
            OWNER=$(echo "$REPO" | cut -d'/' -f1)
            NAME=$(echo "$REPO" | cut -d'/' -f2)
            echo "Processing $REPO..."
            mkdir -p "$NAME"

            # Try main branch first
            URL_MAIN="https://${{secrets.PAT}}@raw.githubusercontent.com/$OWNER/$NAME/main/README.md"

            if curl -fsSL "$URL_MAIN" -o "$NAME/README.md" 2>/dev/null; then
              echo "✅ Downloaded README from main branch for $REPO"
            else
              # Try master branch as fallback
              URL_MASTER="https://${{secrets.PAT}}@raw.githubusercontent.com/$OWNER/$NAME/staging/README.md"

              if curl -fsSL "$URL_MASTER" -o "$NAME/README.md" 2>/dev/null; then
                echo "✅ Downloaded README from staging branch for $REPO"
              else
                echo "❌ ERROR: README not found for $REPO (tried both main and staging branches)"
                rm -rf "$NAME"
              fi
            fi
          done

      - name: Commit and Push Changes
        run: |
          git config --global user.email "ci@github.com"
          git config --global user.name "GitHub Actions"
          git add .
          git commit -m "Auto-rebuild for commit ${GITHUB_SHA::7} from ${{ github.event.client_payload.source_repo }}" || echo "No changes"
          git push
